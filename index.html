<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    <h2 id="titulo">Editar Alunos</h2>
    <div><label>Nome:</label><input id="nome" type="text"></div>
    <div><label>Sobrenome:</label><input id="nobrenome" type="text"></div>
    <div><label>Telefone:</label><input id="telefone" type="text"></div>
    <div><label>RA:</label><input id="ra" type="text"></div>
    <div>
        <button id="btnSalvar" onclick="Cadastrar()">Cadastrar</button>
        <button id="btnCancelar" onclick="Cancelar()">Limpar</button>
    </div>

    <table border="1">
        <thead>
            <tr>
                <td>Nome</td>
                <td>Sobrenome</td>
                <td>Telefone</td>
                <td>RA</td>
                <td>Opções</td>
            </tr>
        </thead>
        <tbody>
            <tr>
            </tr>
        </tbody>
    </table>

    <script type="text/javascript">

        var tbody = document.querySelector('table tbody');
        var aluno;

        function Cadastrar() {
            aluno.Nome = document.querySelector('#nome').value;
            aluno.Sobrenome = document.querySelector('#nobrenome').value;
            aluno.Telefone = document.querySelector('#telefone').value;
            aluno.Ra = document.querySelector('#ra').value;

            console.log(aluno);

            if (aluno.Id === undefined || aluno.Id === 0) {
                carregaEstudantes('POST', 0, aluno);
            }
            else {
                carregaEstudantes('PUT', aluno.Id, aluno);
            }
        }

        function Cancelar() {
            var btnSalvar = document.querySelector('#btnSalvar');
            var btnCancelar = document.querySelector('#btnCancelar');
            var titulo = document.querySelector('#titulo');
            document.querySelector('#nome').value = '';
            document.querySelector('#nobrenome').value = '';
            document.querySelector('#telefone').value = '';
            document.querySelector('#ra').value = '';

            btnSalvar.textContent = 'Cadastrar';
            btnCancelar.textContent = 'Limpar';
            titulo.textContent = 'Editar Aluno';
        }

        function carregaEstudantes(metodo, id, corpo) {
            tbody.innerHTML = ''; //antes de mais nada, limpa a tabela
            var xhr = new XMLHttpRequest();

            if (id === undefined || id === 0) {
                id = '';
            }
            
            xhr.open(metodo, `http://localhost:59189/api/Teste/${id}`, true);
            
            xhr.onload = function () {
                var estudantes = JSON.parse(this.responseText);
                for (var index in estudantes) {
                    adicionaLinha(estudantes[index]);
                }
            }

            if (corpo !== undefined) {
                xhr.setRequestHeader('content-type', 'application/json'); //igual no postman, o tipo de envio
                xhr.send(JSON.stringify(corpo)); //antes converte para string
            }
            else {
                xhr.send();
            }
        }

        carregaEstudantes('GET');

        function editarEstudante(estudante) {
            var btnSalvar = document.querySelector('#btnSalvar');
            var btnCancelar = document.querySelector('#btnCancelar')
            var titulo = document.querySelector('#titulo')
            document.querySelector('#nome').value = estudante.Nome;
            document.querySelector('#nobrenome').value = estudante.Sobrenome;
            document.querySelector('#telefone').value = estudante.Telefone;
            document.querySelector('#ra').value = estudante.Ra;

            btnSalvar.textContent = 'Salvar';
            btnCancelar.textContent = 'Cancelar';
            titulo.textContent = `Editando aluno - ${estudante.Nome}`;
            aluno = estudante;
        }

        function deletarEstudante(id) {
            carregaEstudantes('DELETE', id);
        }

        function adicionaLinha(estudante) {
            var trow = `<tr>
                            <td>${estudante.Nome}</td>
                            <td>${estudante.Sobrenome}</td>
                            <td>${estudante.Telefone}</td>
                            <td>${estudante.Ra}</td>
                            <td>
                                <button onclick='editarEstudante(${JSON.stringify(estudante)})'>Editar</button>
                                <button onclick='deletarEstudante(${estudante.Id})'>Deletar</button>
                            </td>
                        </tr>
                       `
            tbody.innerHTML += trow;
        }

    </script>
</body>
</html>